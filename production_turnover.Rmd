---
title: "Root production and turnover"
output: 
  github_document:
    toc: yes
---
<!-- ## GitHub Documents -->

<!-- This is an R Markdown format used for publishing markdown documents to GitHub. When you click the **Knit** button all R code chunks are run and a markdown file (.md) suitable for publishing to GitHub is generated. -->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
knitr::opts_chunk$set(fig.height = 8, fig.width = 6)
```

```{r load packages and data}
library(tidyverse)
## Import corrected roots data
df <- read_csv("data/processed_data/mr_roots_data_corrected.csv")

library(readxl)
## Import plot treatment data
trt <- read_xlsx("data/treatments.xlsx")
#cut
#cut+manure
#control

mr_plot_data <- read_csv("data/processed_data/mr_plots_monthly_data.csv")

```

```{r add length and diam class groupings}
## Make size class groupings of root length
df <- df %>% 
  # group_by(root_status) %>% 
  mutate(length_bin = 
           case_when(
             Length_mm < 1 ~ "<1 mm",
             between(Length_mm, 1, 3) ~ "1 - 3 mm",
             between(Length_mm, 3.0001, 5) ~ ">3 - 5 mm",
             between(Length_mm, 5.0001, 7) ~ ">5 - 7 mm",
             between(Length_mm, 7.0001, 9) ~ ">7 - 9 mm",
             between(Length_mm, 9.0001, 11) ~ ">9 - 11 mm",
             between(Length_mm, 11.0001, 13) ~ ">11 - 13 mm",
             between(Length_mm, 13.0001, 15) ~ ">13 - 15 mm",
             # between(Length_mm, 8.0001, 9) ~ ">8 - 9 mm",
             # between(Length_mm, 9.0001, 10) ~ ">9 - 10 mm",
             Length_mm > 15 ~ ">15 mm"
           ) %>% 
           factor(levels = c("<1 mm","1 - 3 mm", ">3 - 5 mm", ">5 - 7 mm", 
                             ">7 - 9 mm", ">9 - 11 mm", ">11 - 13 mm", 
                             ">13 - 15 mm", 
                             # ">8 - 9 mm", 
                             # ">9 - 10 mm", 
                             ">15 mm"))
  )
  
df <- df %>% mutate(
  diam_bin = case_when(
    AvgDiam_mm < 1 ~ "<1 mm",
    between(AvgDiam_mm, 1, 1.5) ~ "1 - 1.5 mm",
    between(AvgDiam_mm, 1.5001, 2) ~ ">1.5 - 2 mm",
    between(AvgDiam_mm, 2.0001, 2.5) ~ ">2 - 2.5 mm",
    between(AvgDiam_mm, 2.5001, 3) ~ ">2.5 - 3 mm",
    between(AvgDiam_mm, 3.0001, 3.5) ~ ">3 - 3.5 mm",
    between(AvgDiam_mm, 3.5001, 4) ~ ">3.5 - 4 mm",
    between(AvgDiam_mm, 4.0001, 4.5) ~ ">4 - 4.5 mm",
    between(AvgDiam_mm, 4.5001, 5) ~ ">4.5 - 5 mm",
    between(AvgDiam_mm, 5.0001, 5.5) ~ ">5 - 5.5 mm",
    between(AvgDiam_mm, 5.5001, 6) ~ ">5.5 - 6 mm",
    AvgDiam_mm > 6 ~ ">6 mm"
    ) %>% 
    factor(levels = c(
      "<1 mm",
      "1 - 1.5 mm", 
      ">1.5 - 2 mm", 
      ">2 - 2.5 mm",
      ">2.5 - 3 mm",
      ">3 - 3.5 mm",
      ">3.5 - 4 mm",
      ">4 - 4.5 mm",
      ">4.5 - 5 mm",
      ">5 - 5.5 mm",
      ">5.5 - 6 mm",
      ">6 mm"))
  )

df <- left_join(df, trt, by = c("Tube" = "rhizotron_tube"))
df <- df %>% 
  mutate(plot_id = paste0(plot, subplot),
         month_num = Month)
```


CW: use MR + models to get at dynamic rates with depth, and static cores to get biomass/length with depth, then propagate them together to get summed fluxes of production and turnover.

What changes happen in gross production and turnover?

Need to work on flagging zombies & wanderers

# Calculating Estimates of Root Production and Turnover
<!-- Milchunas (2009): "good agreement between pulse-isotope turnover and minirhizotron were obtained when minirhizotron estimates were *calculated from regression of decomposition versus production to equilibrium* and when pulse-isotope turnover estimates were calculated from two-phase life-span  regressions." -->

Turnover = entering decomposition, sloughing of roots ("gone"); deposition into the soil

  - individual present then gone (restrictive)
  - individual present but lost size (length and/or diameter; use volume? mass)

Split turnover into 2 parts

Alive --> Dead = senescence
Alive or Dead --> Gone = turnover (decomposition)

Alive to gone = senescence + turnover? (but wanderers)
 
 or

Force "dead" before it can be "gone" for turnover definition? Stronger confidence that it is truly gone into decomposition and turnover rather than wanderer.

We can infer that "Gone" roots reappearing as "Alive" later were "Alive" in between observations, but what about the hidden wanderers, those that haven't reappeared yet?  (Have yet to take any action related to this; all observations are treated as-is)

Rate/ratio of alive to dead at time t or time t to time t-1

Rate of production of "alive" roots

***New production & new loss for each root, then aggregate to the frame***

Calculate gross change for individual roots in length, diameter, and volume between each time step, for alive, dead, gone. The change values can then be aggregated to the depth window.

- flag completely new and totally gone?

Balogianni et al. (2016): "**Root production** was defined as the sum of the length of new roots formed and any increase in length of existing roots since the previous sampling day (Johnson et al. 2001). **Root mortality** was defined as the sum of the length of roots that had disappeared and any decrease in length of existing roots since the previous sampling day. Root production and mortality for each interval was expressed as the average meters of root length that appeared or disappeared per square meter image area per day (m m−2 days−1) in each tube."

Number of new root IDs since initiation in April
 
```{r new roots since April}
# df %>% distinct(root_ID)

april_roots <- df %>% 
  filter(Month == 4) 
new_roots <- df %>% 
  filter(Month > 4) %>% 
  filter(!root_ID %in% april_roots$root_ID)

# print(paste("April roots:", nrow(april_roots)))
# print(paste("Total new roots:", new_roots %>% distinct(root_ID) %>% nrow()))
```

April roots: `r nrow(april_roots)`

New roots: `r new_roots %>% distinct(root_ID) %>% nrow()`

That's more new root IDs than I thought there would be.

<!-- ## Analyzing individual roots -->
<!-- Rate of appearance in dead and gone column of individual roots -->

<!-- Individual roots days to senescence (dead) or turnover (gone) -->

<!-- Kaplan-Meier or Cox proportional hazard regression -->

<!-- - days to event (senescence or turnover) for individual roots -->
<!-- - 30-day step -->

<!-- Kaplan-Meier: estimate median survivorship/longevity of individual or cohort. "Censoring" for alive/dead - roots still alive at end of period results in underestimates longevity. -->

<!-- Cox: estimate "death hazard" at any given time in relation to other covariates -->


1. Length, Diameter, Production, Turnover by Depth

2. Length, Diameter, Production, Turnover by Day of Year (Month)


<!-- Size (diameter) & depth biplot of days to senescence -->


# Production and loss (change) of individual roots
Calculate gross change for individual roots in length, diameter, and volume between each time step, for alive, dead, gone. The change values can then be aggregated to the depth window.

<!-- CW: I think the main change is that we need to separate out the gains and losses. So, ind_gain_sum should actually be split into gross gain and gross loss. Then, the next step is to add new roots into the gross gain, and add newly dead or gone roots to the gross loss. -->

<!-- After doing that, we aggregate to each depth window, but now have gross production and gross turnover by window. -->

<!-- Is "gross loss" then the sum of 'Dead', 'Gone' and negative values of 'Alive'? -->

**Gross Gain** = growth of existing roots + new roots

**Gross Loss** = loss of existing roots + dead roots + gone roots

```{r individual_root_changes, echo=FALSE}
## Calculate gross gain and gross loss in length, diameter, and
## volume between each observation for each root

# calculate change of individual roots
## given the definition of gross gain & loss could do only 'Alive'
ind_chg <- df %>% 
  select(obs_ID, root_ID, Tube, Location, Date, Session, Month, root_status, 
         Length_mm, AvgDiam_mm, Volume_mm3, treatment) %>% 
  arrange(root_ID, Session) %>% 
  group_by(root_ID, root_status, Tube, Location, treatment) %>% 
  # lag subtracts the previous value; NAs when there is no value to subtract
  mutate(length_change = Length_mm - lag(Length_mm, n = 1),
         diam_change = AvgDiam_mm - lag(AvgDiam_mm, n = 1),
         volume_change = Volume_mm3 - lag(Volume_mm3, n = 1)) %>% 
  ungroup(.)

## Not a very elegant solution follows...
ind_gross_chg <- ind_chg %>% 
  select(-Length_mm:-Volume_mm3) %>%
  rename(length = length_change, diameter = diam_change, 
         volume = volume_change) %>% 
  # long format to use metric as grouping variable
  pivot_longer(length:volume)

# gross gain = growth of 'Alive' + new roots
growth <- ind_gross_chg %>% 
  # summarise growth of existing roots to each depth
  filter(root_status == 'Alive', value >= 0) %>% 
  group_by(Tube, Location, Month, name, treatment) %>% 
  summarise(root_growth = sum(value)) %>% 
  ungroup(.)
# summary(growth)

# New roots after April
new_roots <- ind_gross_chg %>%
  # only roots that have NA for the change value
  filter(Month > 4, root_status == 'Alive', is.na(value)) %>% 
  distinct(root_ID, Tube, Location, Month, treatment) %>% 
  # get only these root IDs & recombine with gross values
  left_join(., ind_chg %>% select(root_ID, Tube, Location, Month, Length_mm:Volume_mm3)) %>%
  # rename in prep for joining with 'growth' data frame
  rename(length = Length_mm, diameter = AvgDiam_mm, 
         volume = Volume_mm3) %>%
  # match data format of 'growth'
  pivot_longer(length:volume) %>% 
  group_by(Tube, Location, Month, name, treatment) %>% 
  summarise(new_roots = sum(value)) %>% 
  ungroup(.)
# summary(new_roots)
# new_roots %>% filter(new_roots>100)

# join growth with new roots
gain_depth <- left_join(growth, new_roots)
# add growth & new roots to get gross gain
gain_depth <- gain_depth %>% 
  mutate(
    # hacky solve of NAs from the join
    new_roots = ifelse(is.na(new_roots), 0, new_roots),
    gross_gain = root_growth + new_roots
    )
gain_depth %>% summary()

# gross loss = loss in 'Alive' + 'Dead' + 'Gone' 
# get loss in 'Alive' roots (analogous to 'growth')
loss <- ind_gross_chg %>%
  filter(root_status == 'Alive' & value < 0) %>% 
  group_by(Tube, Location, Month, name, treatment) %>% 
  summarise(root_loss = sum(abs(value))) %>% 
  ungroup(.)

# get amounts *newly* 'Dead' and 'Gone' roots (analogous to new_roots)
dead_gone <- ind_gross_chg %>%
  # only Dead & Gone roots that have NA for the change value
  filter(Month > 4, root_status %in% c('Dead', 'Gone'),
         is.na(value)) %>% 
  # get only these root IDs & recombine with gross values
  distinct(root_ID, Tube, Location, Month, treatment) %>% 
  left_join(., ind_chg %>% select(root_ID, Tube, Location, Month, Length_mm:Volume_mm3, treatment)) %>%
  rename(length = Length_mm, diameter = AvgDiam_mm,
         volume = Volume_mm3) %>%
  pivot_longer(length:volume) %>% 
  group_by(Tube, Location, Month, name, treatment) %>% 
  summarise(dg_roots = sum(value)) %>% 
  ungroup(.)

loss_depth <- left_join(dead_gone, loss)
loss_depth <- loss_depth %>% 
  mutate(root_loss = ifelse(is.na(root_loss), 0, root_loss),
    gross_loss = dg_roots + root_loss)
summary(loss_depth)

# Combine so that gross gain and gross loss are in one data frame
gross_change <- df %>%
  filter(Month > 4) %>% 
  distinct(Tube, Location, Month, treatment) %>% 
  left_join(., gain_depth) %>% 
  left_join(., loss_depth)

```

```{r net change, eval=F}
## Sum change values to depth window (this produces net change)
ind_chg_sum <- ind_chg %>% 
  group_by(Tube, Location, root_status, Month, Date) %>% 
  summarise(Length_mm = sum(Length_mm),
            AvgDiam_mm_sum = sum(AvgDiam_mm),# should this be averaged instead?
            Volume_mm3 = sum(Volume_mm3),
            length_change = sum(length_change, na.rm = T),
            diam_change = sum(diam_change, na.rm = T),
            volume_change = sum(volume_change, na.rm = T)
  ) %>% 
  ungroup(.)
```


Figure of gross gain and gross loss aggregated to depth window.

```{r plot_root_change, fig.width=8, fig.height=10}
# ind_chg %>% 
#   group_by(root_status) %>% 
#   select(length_change:volume_change) %>% 
#   skimr::skim()
# 
# ind_chg %>% view
# 
# ind_chg %>% 
#   filter(Tube == 12, Location == 39) %>% 
#   ggplot() +
#   geom_point(aes(Month, diam_change, color = root_ID, shape = root_status))

## Individual roots
# ggplot(ind_chg, aes(Location*-1, diam_change)) +
#   geom_point(alpha = .1) +
#   # stat_summary(fun.data = "mean_cl_boot", color = "red", size = .2) +
#   stat_summary(fun.data = "mean_se", color = "deepskyblue", size = .2) +
#   # stat_summary(fun = "median", color = "deepskyblue", size = .2) +
#   geom_smooth() +
#   coord_flip() +
#   facet_grid(Month ~ root_status) +
#   xlab("Relative depth") +
#   ylab("Change in average diameter (cm)") +
#   theme_bw() +
#   theme(
#     # legend.position = c(.8, .8),
#     # legend.title = element_blank(),
#     strip.background = element_blank(),
#     panel.grid.minor = element_blank()
#     )
gc <- gross_change %>% 
  filter(!is.na(gross_gain)) %>% 
  select(Tube:name, treatment, gross_gain, gross_loss) %>% 
  rename(metric = name) %>% 
  pivot_longer(gross_gain:gross_loss)

measure <- "length"
ggplot(gc %>% filter(metric == measure), aes(Location*-1, value, color = name)) +
  geom_point(alpha = .2, size = .5) +
  geom_smooth(method = "gam", size = .5, show.legend = T, se = F) +
  scale_color_manual(values = c("deepskyblue", "red")) +
  coord_flip() +
  facet_grid(Month ~ treatment) +
  xlab("Relative depth") +
  ylab(paste("Gross change", measure, "(mm)")) +
  theme_bw() +
  theme(
    strip.background = element_blank(),
    panel.grid.minor = element_blank(),
    legend.title = element_blank()
    )

# ggplot(ind_chg_sum, aes(Location*-1, diam_change, color = root_status)) +
#   geom_point(alpha = .2, size = .5) +
#   geom_smooth(method = "gam", size = .5) +
#   coord_flip() +
#   facet_grid(Month ~ root_status) +
#   xlab("Relative depth") +
#   # ylab("Total change in mean diameter (cm)") +
#   theme_bw() +
#   theme(
#     strip.background = element_blank(),
#     panel.grid.minor = element_blank()
#     )
# 
# ggplot(ind_chg_sum, aes(Location*-1, volume_change, color = root_status)) +
#   geom_point(alpha = .2, size = .5) +
#   geom_smooth(method = "gam", size = .5) +
#   coord_flip() +
#   facet_grid(Month ~ root_status) +
#   xlab("Relative depth") +
#   # ylab("Total change in mean diameter (cm)") +
#   theme_bw() +
#   theme(
#     strip.background = element_blank(),
#     panel.grid.minor = element_blank()
#     )

```

Compare calculated gross change (gain - loss) from T~1~ to T~2~ to the observed total at T~2~ of root length for each window.

### Sanity Check
```{r sanity check gain loss, echo=FALSE, fig.height=4, fig.width=4}

df1 <- left_join(
  df %>% filter(root_status == "Alive") %>% 
    group_by(Tube, Location, Month, treatment) %>% 
    summarise(TotLength_mm = sum(TotLength_mm)),
  gross_change %>% 
    filter(name == "length")
) %>% 
  ungroup(.)
df1 <- df1 %>% 
  select(Tube:TotLength_mm, gross_gain, gross_loss) %>% 
  mutate(calc_net = lag(TotLength_mm, n = 1) + gross_gain - gross_loss)
# View(df1)

# A peek at the resulting dataframe
df1
ggplot(df1, aes(TotLength_mm, calc_net)) +
  geom_point() +
  geom_abline(slope = 1) +
  ylab("Calculated net of gross gain and gross loss") +
  xlab("Observed minirhizo TotLength (mm)") +
  theme_classic() +
  NULL

# I think we're pretty okay here

with(df1, cor(calc_net, TotLength_mm, use = "complete.obs"))

```


# Modeling


## Gross change
```{r model gross change}
library(lme4)

df2 <- gross_change %>% 
  filter(name == "length") %>% 
  group_by(Tube, Location, treatment) %>% 
  summarise(gg_sum = sum(gross_gain, na.rm = TRUE),
            gl_sum = sum(gross_loss, na.rm = TRUE)) %>% 
  ungroup(.) %>% 
  pivot_longer(., c(gg_sum, gl_sum))

ggplot(df2 %>% filter(), aes(x = Location*-1, y = value, 
                             color = treatment, shape = name)) +
  geom_point(alpha = .5, size = 1) +
  geom_smooth(aes(linetype = name), method = "gam", size = .8,
              show.legend = T, se = F) +
  # scale_color_manual(values = c("deepskyblue", "red")) +
  coord_flip() +
  # facet_grid(. ~ treatment) +
  xlab("Relative depth") +
  ylab("Gross length change") +
  theme_bw() +
  theme(
    strip.background = element_blank(),
    panel.grid.minor = element_blank(),
    legend.title = element_blank()
    )

# separate clipped and manure
df2 <- df2 %>% 
  mutate(clipped = as.factor(ifelse(treatment!="control", "yes", "no")),
         manure = as.factor(ifelse(treatment=="cut+manure", "yes", "no")))

d <- df2 %>%
  pivot_wider(.,names_from = name, values_from = value)

m <- lmer(gl_sum ~ clipped + clipped:manure + (1|Location) + (1|Tube), data = d)
summary(m)
gl_re_plot <- sjPlot::plot_model(m, type = "re", colors = "black",
                                 title = "Gross length loss random effects")

library(patchwork)
p1 <- (gl_re_plot[[1]] + xlab("Relative depth")) / 
  (gl_re_plot[[2]] + xlab("Tube") + ggtitle("") )


m2 <- lmer(gg_sum ~ clipped + clipped:manure + (1|Location) + (1|Tube), data = d)
summary(m2)
gg_re_plot <- sjPlot::plot_model(m2, type = "re", colors = "black",
                                 title = "Gross length gain random effects")

p2 <- (gg_re_plot[[1]] + xlab("Relative depth")) /
  (gg_re_plot[[2]] + xlab("Tube") + ggtitle(""))

(p1 | p2)
```


## Living roots (production)
Our goal here is to grab at the "low-hanging fruit" using mixed-effects regression models to evaluate treatment affects and additional covariates. The response and explanatory variables are listed below. I think one open question as we go through iterations of model development is when to apply the (relative) depth as a continous explanatory factor vs. a random intercept - the answer to this depends on the question we're trying to answer.

**Response variables - living roots**

 * (Average) length
 * (Average) volume
 * (Average) diameter

Finest resolution is individual roots. Aggregate (average) response variables to:

 * Depth window (plot/tube/depth)
 * Depth class (e.g. 1-5 cm, 6-10 cm, etc.)
 * Tube (plot/tube)
 * Plot (plot)
 
**Explanatory covariates**

Plot level

 * Treatment (uncut, cut, cut + manure)
 * Composition (bahia, mixed)
 * LAI (leaf area index)
 * Soil moisture (VWC)
 * Soil temperature
 * Aboveground biomass
 * Sample month
 
Random effects (intercepts)

 * (1|depth)
 * (1|tube)
 * (1|month/depth)
 
```{r data grouping}
mr_plot_data <- mr_plot_data %>% 
  mutate(clipped = as.factor(ifelse(treatment!="control", "yes", "no")),
         manure = as.factor(ifelse(treatment=="cut+manure", "yes", "no")))

## Calculate the sum and average at each depth window - 1st step up from roots
depth_data <- df %>% 
  group_by(plot_id, Tube, block, Location, root_status, month_num, Date) %>% 
  summarise(tot_length_mm = sum(Length_mm),
            avg_length_mm = mean(Length_mm),
            tot_volume_mm3 = sum(TotVolume_mm3),
            avg_volume_mm3 = mean(TotVolume_mm3),
            tot_diam_mm = sum(TotAvgDiam_mm),
            avg_diam_mm = mean(TotAvgDiam_mm)) %>% 
  ungroup(.)
depth_data <- left_join(depth_data, mr_plot_data)

## Calculate the sum and average at each tube - 2nd stup up from roots
tube_data <- df %>% 
  group_by(plot_id, Tube, block, root_status, month_num, Date) %>% 
  summarise(tot_length_mm = sum(Length_mm),
            avg_length_mm = mean(Length_mm),
            tot_volume_mm3 = sum(TotVolume_mm3),
            avg_volume_mm3 = mean(TotVolume_mm3),
            tot_diam_mm = sum(TotAvgDiam_mm),
            avg_diam_mm = mean(TotAvgDiam_mm)) %>% 
  ungroup(.)
tube_data <- left_join(tube_data, mr_plot_data)

## Individual roots data.
roots_data <- left_join(df, mr_plot_data)
```

## Root measurements aggregated to measurement depth ("Location")
The sum of each metric was calculated at each combination of Tube, Location (depth), Month & Date (equivalent but keeping Date handy), and root_status.

In the plots, points are the sum values and lines are the fit from `geom_smooth(method = 'gam', formula = 'y ~ s(x, bs="cs)')`.

We have totals for:

- root length (mm)
- projected area (mm2)
- surface area (mm2)
- average diameter (cm)
- volume (mm3)

Depth is roughly 1 cm sections (1 cm x 1 cm minirhizotron image windows).

```{r agg_to_depth}
df2 <- df %>% 
  group_by(Tube, Location, root_status, Month, Date) %>% 
  summarise(Length_mm = sum(Length_mm),
            ProjArea_mm2 = sum(ProjArea_mm2),
            SurfArea_mm2 = sum(SurfArea_mm2),
            AvgDiam_mm_sum = sum(AvgDiam_mm),# should this be averaged instead?
            AvgDiam_mm_avg = mean(AvgDiam_mm),
            Volume_mm3 = sum(Volume_mm3)) %>% 
  ungroup(.)
```

```{r total_root_length_depth_month}
ggplot(df2, aes(Location*-1, Length_mm)) +
  geom_point(alpha = .2) +
  # stat_summary(fun.data = "mean_se", color = "deepskyblue", size = .2) +
  geom_smooth(method = "gam") +
  coord_flip() +
  facet_grid(Month ~ root_status) +
  xlab("Relative depth (cm)") +
  ylab("Total root length (mm)") +
  theme_bw() +
  theme(
    # legend.position = c(.8, .8),
    # legend.title = element_blank(),
    strip.background = element_blank(),
    panel.grid.minor = element_blank()
    )
```

```{r total_avg_diam}
ggplot(df2, aes(Location*-1, AvgDiam_mm_sum)) +
  geom_point(alpha = .2) +
  geom_smooth(method = "gam") +
  coord_flip() +
  facet_grid(Month ~ root_status) +
  xlab("Relative depth (cm)") +
  ylab("Total mean diameter (cm)") +
  theme_bw() +
  theme(
    strip.background = element_blank(),
    panel.grid.minor = element_blank()
    )
```

```{r total_volume}
ggplot(df2, aes(Location*-1, Volume_mm3)) +
  geom_point(alpha = .2) +
  geom_smooth(method = "gam") +
  coord_flip() +
  facet_grid(Month ~ root_status) +
  xlab("Relative depth") +
  ylab("Total volume (mm3)") +
  theme_bw() +
  theme(
    strip.background = element_blank(),
    panel.grid.minor = element_blank()
    )
```

<!-- Are these surface area estimates of current interest? -->
```{r total_surface_area, eval=F}
ggplot(df2, aes(Location*-1, SurfArea_mm2)) +
  geom_point(alpha = .2) +
  geom_smooth(method = "gam") +
  coord_flip() +
  facet_grid(Month ~ root_status) +
  xlab("Relative depth") +
  ylab("Total surface area (mm2)") +
  theme_bw() +
  theme(
    strip.background = element_blank(),
    panel.grid.minor = element_blank()
    )
```

<!-- I don't even know what "proj_area" is -->
```{r total_proj_area, eval=F}
ggplot(df2, aes(Location*-1, ProjArea_mm2)) +
  geom_point(alpha = .2) +
  geom_smooth(method = "gam") +
  coord_flip() +
  facet_grid(Month ~ root_status) +
  xlab("Relative depth") +
  ylab("Total projected area (mm2)") +
  theme_bw() +
  theme(
    strip.background = element_blank(),
    panel.grid.minor = element_blank()
    )
```


### Models for roots measures aggregated to each depth
Depth is the observation unit. 

```{r depth aggregated data}
library(lme4)

## Calculate standardized variables, center & divide by 2*SD
depth_model_data <- depth_data %>% 
  filter(root_status == "Alive") %>% 
  select(Tube, depth = Location, tot_length_mm:avg_diam_mm, composition,
         clipped, manure, month_num, avg_vwc:avg_sem, block, plot_id, treatment) %>% 
  mutate(std2_max_temp = effectsize::standardize(max_temp, two_sd = TRUE),
         std2_min_temp = effectsize::standardize(min_temp, two_sd = TRUE),
         std2_avg_temp = effectsize::standardize(avg_temp, two_sd = TRUE),
         std2_avg_vwc = effectsize::standardize(avg_vwc, two_sd = TRUE),
         std2_avg_lai = effectsize::standardize(avg_lai, two_sd = TRUE))

## Subset of data because LAI measurements don't begin until July
depth_lai_model_data <- depth_model_data %>% 
  filter(!is.na(avg_lai))
```

I calculate maximum temperature, minimum temperature, and average temperature for each month, so these metrics only roughly correspond to the time around when the root images were taken. Ideally these temperature values would be for the temperatures recorded between the t and t-1 measurements (I'm being a little lazy on the first pass).

I do fit and compare separate models for the max, min, and average. Hopefully I was consistent so that models with "d1" = max temp, "d2" = min temp, and "d3" = avg temp.

The model pseudocode is:

` lmer(root metric ~ temperature metric + avg_vwc + clipped + clipped:manure + composition + (1 | depth) + (1 | Tube) + (1 | month_num), data = depth_model_data) `

<!-- #### Average root length  --> 
<!-- Scratch this -->
```{r depth avg root length, eval=F}
len_avg_d1 <- lmer(avg_length_mm ~ max_temp + avg_vwc + clipped + clipped:manure + composition + (1 | depth) + (1 | Tube) + (1 | month_num), data = depth_model_data)
len_avg_d2 <- lmer(avg_length_mm ~ min_temp + avg_vwc + clipped + clipped:manure + composition + (1 | depth) + (1 | Tube) + (1 | month_num), data = depth_model_data)
len_avg_d3 <- lmer(avg_length_mm ~ avg_temp + avg_vwc + clipped + clipped:manure + composition + (1 | depth) + (1 | Tube) + (1 | month_num), data = depth_model_data)

AIC(len_avg_d1, len_avg_d2, len_avg_d3) %>% 
  arrange(AIC)# kinda all the same

plot(len_avg_d1)
DHARMa::simulateResiduals(len_avg_d1) %>% plot()

summary(len_avg_d1)
sjPlot::plot_model(len_avg_d1, show.values = T)
re <- sjPlot::plot_model(len_avg_d1, type = "re")
re[[1]] + ggtitle("Random effects: depth")
re[[2]] + ggtitle("Random effects: tube")
re[[3]] + ggtitle("Random effects: month ")
# Order of plots: depth, tube, month

len_avg_d1a <- lmer(avg_length_mm ~ std2_max_temp + std2_avg_vwc + clipped + clipped:manure + composition + (1 | depth) + (1 | Tube) + (1 | month_num), data = depth_model_data)
sjPlot::plot_model(len_avg_d1a, show.values = T) +
  ggtitle("Avg length model fit to standardized variables")
```

<!-- All interpretations with a grain of salt given the less than ideal model diagnostic plots. -->

<!-- Some treatment effect from clipping and simulated grazing (clipping + manure) - clipping alone has shorter while simulated grazing has longer. -->

#### Summed root length
```{r depth summed root length, eval=TRUE}
len_tot_d1 <- lmer(tot_length_mm ~ max_temp + avg_vwc + clipped + clipped:manure + composition + (1 | depth) + (1 | Tube) + (1 | month_num), data = depth_model_data)
len_tot_d2 <- lmer(tot_length_mm ~ min_temp + avg_vwc + clipped + clipped:manure + composition + (1 | depth) + (1 | Tube) + (1 | month_num), data = depth_model_data)
len_tot_d3 <- lmer(tot_length_mm ~ avg_temp + avg_vwc + clipped + clipped:manure + composition + (1 | depth) + (1 | Tube) + (1 | month_num), data = depth_model_data)
AIC(len_tot_d1, len_tot_d2, len_tot_d3) %>% 
  arrange()

plot(len_tot_d1)
DHARMa::simulateResiduals(len_tot_d1) %>% plot()

summary(len_tot_d1)
sjPlot::plot_model(len_tot_d1, type = "est", show.values = T)
re <- sjPlot::plot_model(len_tot_d1, type = "re")
re[[1]] + ggtitle("Random effects: depth")
re[[2]] + ggtitle("Random effects: tube")
re[[3]] + ggtitle("Random effects: month ")
# Order of plots: depth, tube, month
```


#### Average root length model with LAI
Subset of data with no NA values for LAI.

Is LAI confounded with the "clipped" treatment?

```{r depth avg root length LAI}
## add LAI into model - subset of data with no NA values for LAI
avg_len_lai_d1 <- lmer(avg_length_mm ~ max_temp + avg_vwc + avg_lai + composition + (1 | depth) + (1 | Tube) + (1 | month_num), data = depth_lai_model_data)
summary(avg_len_lai_d1)
sjPlot::plot_model(avg_len_lai_d1, show.values = T)

re <- sjPlot::plot_model(avg_len_lai_d1, type = "re")
(re[[1]] + ggtitle("Random effects: depth")) 
(re[[2]] + ggtitle("Random effects: tube")) 
(re[[3]] + ggtitle("Random effects: month"))
```

No effect of LAI.

#### Summed root length model with LAI
```{r depth summed root length LAI}
len_tot_lai_d1 <- lmer(tot_length_mm ~ max_temp + avg_vwc + avg_lai + composition + (1 | depth) + (1 | Tube) + (1 | month_num), data = depth_model_data)

summary(len_tot_lai_d1)
sjPlot::plot_model(len_tot_lai_d1, show.values = T)
re <- sjPlot::plot_model(len_tot_lai_d1, type = "re")
(re[[1]] + ggtitle("Random effects: depth")) 
(re[[2]] + ggtitle("Random effects: tube")) 
(re[[3]] + ggtitle("Random effects: month"))
```

Pretty strong negative relationship with LAI and maximum temperature.

#### Average root diameter
```{r depth avg root diameter}
## Average root diameter at each depth ####
diam_avg_d1 <- lmer(avg_diam_mm ~ max_temp + avg_vwc + clipped + clipped:manure + composition + (1 | depth) + (1 | Tube) + (1 | month_num), data = depth_model_data)
diam_avg_d2 <- lmer(avg_diam_mm ~ min_temp + avg_vwc + clipped + clipped:manure + composition + (1 | depth) + (1 | Tube) + (1 | month_num), data = depth_model_data)
diam_avg_d3 <- lmer(avg_diam_mm ~ avg_temp + avg_vwc + clipped + clipped:manure + composition + (1 | depth) + (1 | Tube) + (1 | month_num), data = depth_model_data)
AIC(diam_avg_d1, diam_avg_d2, diam_avg_d3) %>% 
  arrange(AIC)# kinda all the same

plot(diam_avg_d1)
DHARMa::simulateResiduals(diam_avg_d1) %>% plot()

summary(diam_avg_d1)
sjPlot::plot_model(diam_avg_d1, show.values = T) +
  scale_y_continuous(c(-.1,.1))
re <- sjPlot::plot_model(diam_avg_d1, type = "re")
re[[1]] + ggtitle("Random effects: depth")
re[[2]] + ggtitle("Random effects: tube")
re[[3]] + ggtitle("Random effects: month")
# Order of plots: depth, tube, month

diam_avg_d1a <- lmer(avg_diam_mm ~ std2_max_temp + std2_avg_vwc + clipped + clipped:manure + composition + (1 | depth) + (1 | Tube) + (1 | month_num), data = depth_model_data)
sjPlot::plot_model(diam_avg_d1a, show.values = T) +
  scale_y_continuous(limits = c(-.1, .1)) +
  ggtitle("Avg diameter model with standardized variables")
```

Average root diameter is larger in the mixed versus the bahia only composition. The scale of these coefficient estimates is super tiny - 100ths of millimeters. 

Peanut roots contributing to larger average diameter

#### Average root diameter model with LAI
```{r depth avg root diameter with LAI}
## add LAI into model - subset of data with no NA values for LAI
avg_diam_lai_d1 <- lmer(avg_diam_mm ~ max_temp + avg_vwc + avg_lai + composition + (1 | depth) + (1 | Tube) + (1 | month_num), data = depth_lai_model_data)
summary(avg_diam_lai_d1)
sjPlot::plot_model(avg_diam_lai_d1, show.values = T) +
  scale_y_continuous(limits = c(-.1,.1))

re <- sjPlot::plot_model(avg_diam_lai_d1, type = "re")
(re[[1]] + ggtitle("Random effects: depth")) 
(re[[2]] + ggtitle("Random effects: tube")) 
(re[[3]] + ggtitle("Random effects: month"))
# sjPlot::plot_model(avg_diam_lai_d3, type = "re")
```

A sort of negative relationship with LAI. 

<!-- #### Summed root diameter -->
```{r depth summed root diameter, eval=FALSE}
## Total root diameter at each depth ####
diam_tot_d1 <- lmer(tot_diam_mm ~ max_temp + avg_vwc + clipped + clipped:manure + composition + (1 | depth) + (1 | Tube) + (1 | month_num), data = depth_model_data)
diam_tot_d2 <- lmer(tot_diam_mm ~ min_temp + avg_vwc + clipped + clipped:manure + composition + (1 | depth) + (1 | Tube) + (1 | month_num), data = depth_model_data)
diam_tot_d3 <- lmer(tot_diam_mm ~ avg_temp + avg_vwc + clipped + clipped:manure + composition + (1 | depth) + (1 | Tube) + (1 | month_num), data = depth_model_data)
BIC(diam_tot_d1, diam_tot_d2, diam_tot_d3)
plot(diam_tot_d1)
DHARMa::simulateResiduals(diam_tot_d1) %>% plot()
summary(diam_tot_d1)
sjPlot::plot_model(diam_tot_d1, type = "est", show.values = T)
sjPlot::plot_model(diam_tot_d1, type = "re")

diam_tot_d1a <- lmer(tot_diam_mm ~ std2_max_temp + std2_avg_vwc + clipped + clipped:manure + composition + (1 | depth) + (1 | Tube) + (1 | month_num), data = depth_model_data)
sjPlot::plot_model(diam_tot_d1a, type = "est", show.values = T)
# arm::standardize(diam_tot_d1a) %>% sjPlot::plot_model(., show.values = T)

diam_tot_lai_d3 <- lmer(tot_diam_mm ~ std2_max_temp + std2_avg_vwc + std2_avg_lai + composition + (1 | depth) + (1 | Tube) + (1 | month_num), data = depth_lai_model_data)
summary(diam_tot_lai_d3)
sjPlot::plot_model(diam_tot_lai_d3, show.values = T)
# sjPlot::plot_model(diam_tot_lai_d3, type = "re")
```

#### Average root volume
```{r depth avg root volume}
## Average root volume at each depth ####
volume_avg_d1 <- lmer(avg_volume_mm3 ~ max_temp + avg_vwc + clipped + clipped:manure + composition + (1 | depth) + (1 | Tube) + (1 | month_num), data = depth_model_data)
volume_avg_d2 <- lmer(avg_volume_mm3 ~ min_temp + avg_vwc + clipped + clipped:manure + composition + (1 | depth) + (1 | Tube) + (1 | month_num), data = depth_model_data)
volume_avg_d3 <- lmer(avg_volume_mm3 ~ avg_temp + avg_vwc + clipped + clipped:manure + composition + (1 | depth) + (1 | Tube) + (1 | month_num), data = depth_model_data)
AIC(volume_avg_d1, volume_avg_d2, volume_avg_d3) %>% 
  arrange(AIC)# all the same

plot(volume_avg_d3)
DHARMa::simulateResiduals(volume_avg_d3) %>% plot()

summary(volume_avg_d3)
sjPlot::plot_model(volume_avg_d3, show.values = T)
re <- sjPlot::plot_model(volume_avg_d3, type = "re")
(re[[1]] + ggtitle("Random effects: depth")) 
(re[[2]] + ggtitle("Random effects: tube")) 
(re[[3]] + ggtitle("Random effects: month"))

volume_avg_d3a <- lmer(avg_volume_mm3 ~ std2_avg_temp + std2_avg_vwc + clipped + clipped:manure + composition + (1 | depth) + (1 | Tube) + (1 | month_num), data = depth_model_data)
sjPlot::plot_model(volume_avg_d3a, show.values = T) +
  ggtitle("Avg volume model with standardized variables")
```

Lower average volume in clipped but higher average volume in mixed composition. The mean point estimate for simulated grazing is solidly on the positive side.  

#### Average root volume model with LAI
```{r depth avg root volume with LAI}
## add LAI into model - subset of data with no NA values for LAI
avg_volume_lai_d3 <- lmer(avg_volume_mm3 ~ avg_temp + avg_vwc + avg_lai + composition +  (1 | depth) + (1 | Tube) + (1 | month_num), data = depth_lai_model_data)
plot(avg_volume_lai_d3)

summary(avg_volume_lai_d3)
sjPlot::plot_model(avg_volume_lai_d3, show.values = T)
re <- sjPlot::plot_model(avg_volume_lai_d3, type = "re")
(re[[1]] + ggtitle("Random effects: depth")) 
(re[[2]] + ggtitle("Random effects: tube")) 
(re[[3]] + ggtitle("Random effects: month"))

## Need to think on handling & interpretation of LAI in clipped plots.
```

No effect of LAI.

#### Summed root volume
```{r depth summed root volume, eval=TRUE}
volume_tot_d1 <- lmer(tot_volume_mm3 ~ max_temp + avg_vwc + clipped + clipped:manure + composition + (1 | depth) + (1 | Tube) + (1 | month_num), data = depth_model_data)
volume_tot_d2 <- lmer(tot_volume_mm3 ~ min_temp + avg_vwc + clipped + clipped:manure + composition + (1 | depth) + (1 | Tube) + (1 | month_num), data = depth_model_data)
volume_tot_d3 <- lmer(tot_volume_mm3 ~ avg_temp + avg_vwc + clipped + clipped:manure + composition + (1 | depth) + (1 | Tube) + (1 | month_num), data = depth_model_data)
AIC(volume_tot_d1, volume_tot_d2, volume_tot_d3) %>% 
  arrange(AIC)
plot(volume_tot_d3)
DHARMa::simulateResiduals(volume_tot_d3) %>% plot()
summary(volume_tot_d3)
sjPlot::plot_model(volume_tot_d3, type = "est", show.values = T)
sjPlot::plot_model(volume_tot_d3, type = "re")

volume_tot_d3a <- lmer(tot_volume_mm3 ~ std2_avg_temp + std2_avg_vwc + clipped + clipped:manure + composition + (1 | depth) + (1 | Tube) + (1 | month_num), data = depth_model_data)
sjPlot::plot_model(volume_tot_d3a, type = "est", show.values = T)
# arm::standardize(volume_tot_d1a) %>% sjPlot::plot_model(., show.values = T)

volume_tot_lai_d3 <- lmer(tot_volume_mm3 ~ std2_max_temp + std2_avg_vwc + std2_avg_lai + std2_avg_lai:clipped + clipped + clipped:manure + composition  + (1 | depth) + (1 | Tube) + (1 | month_num), data = depth_lai_model_data)
summary(volume_tot_lai_d3)
sjPlot::plot_model(volume_tot_lai_d3, show.values = T)
# sjPlot::plot_model(volume_tot_lai_d3, type = "re")
```


### Models for roots aggregated to tubes
The MR tube is the observation level.

If I understood the experiment and MR tube setup then each tube is the same as a plot.

```{r subset tube modeling data}
library(lme4)

tube_model_data <- tube_data %>% 
  filter(root_status == "Alive") %>% 
  select(Tube, tot_length_mm:avg_diam_mm, composition, clipped, manure,
         month_num, avg_vwc:avg_sem, block, plot_id, treatment) %>% 
  mutate(std2_avg_temp = effectsize::standardize(avg_temp, two_sd = TRUE),
         std2_min_temp = effectsize::standardize(min_temp, two_sd = TRUE),
         std2_max_temp = effectsize::standardize(max_temp, two_sd = TRUE),
         std2_avg_vwc = effectsize::standardize(avg_vwc, two_sd = TRUE)
         )

tube_lai_model_data <- tube_model_data %>% 
  filter(!is.na(avg_lai)) %>% 
  mutate(std2_avg_temp = effectsize::standardize(avg_temp, two_sd = TRUE),
         std2_min_temp = effectsize::standardize(min_temp, two_sd = TRUE),
         std2_max_temp = effectsize::standardize(max_temp, two_sd = TRUE),
         std2_avg_vwc = effectsize::standardize(avg_vwc, two_sd = TRUE),
         std2_avg_lai = effectsize::standardize(avg_lai, two_sd = TRUE))
```

Model pseudo-code: 

`lmer(root metric ~ temperature metric + avg_vwc + clipped + clipped:manure + composition + (1|block/Tube) + (1|month_num), data = tube_model_data)`

In coming back to this I noticed I used block in the random effect here but not in the depth models...

#### Average root length

```{r tube avg root length}
len_avg_m1 <- lmer(avg_length_mm ~ max_temp + avg_vwc + clipped + clipped:manure + composition + (1|block/Tube) + (1|month_num), data = tube_model_data)
len_avg_m2 <- lmer(avg_length_mm ~ min_temp + avg_vwc + clipped + clipped:manure + composition + (1|block/Tube) + (1|month_num), data = tube_model_data)
len_avg_m3 <- lmer(avg_length_mm ~ avg_temp + avg_vwc + clipped + clipped:manure + composition + (1|block/Tube) + (1|month_num), data = tube_model_data)
AIC(len_avg_m1, len_avg_m2, len_avg_m3) %>% 
  arrange(AIC)# max temp = avg temp

plot(len_avg_m1)
DHARMa::simulateResiduals(len_avg_m1) %>% plot()

summary(len_avg_m1)
sjPlot::plot_model(len_avg_m1, type = "est", show.values = T)
# sjPlot::tab_model(len_avg_m1)
re <- sjPlot::plot_model(len_avg_m1, type = "re", grid = T)
(re[[1]] + ggtitle("Random effects: tube:block")) 
(re[[2]] + ggtitle("Random effects: block")) 
(re[[3]] + ggtitle("Random effects: month"))

len_avg_m1a <- lmer(avg_length_mm ~ std2_max_temp + std2_avg_vwc + clipped + clipped:manure + composition + (1|block/Tube) + (1|month_num), data = tube_model_data)
sjPlot::plot_model(len_avg_m1a, type = "est", show.values = T) +
  ggtitle("Length model with standardized variables")
```

Aggregating up to the tube level tidies up the diagnostic plots in most cases.

Negative effect of clipping - shorter roots.

#### Average root length model with LAI
```{r tube avg length with LAI}
len_avg_lai_m1 <- lmer(avg_length_mm ~ max_temp + avg_vwc + avg_lai + composition + (1|block/Tube) + (1|month_num), data = tube_lai_model_data)
# plot(len_avg_lai_m1)
# DHARMa::simulateResiduals(len_avg_lai_m1) %>% plot()

summary(len_avg_lai_m1)
sjPlot::plot_model(len_avg_lai_m1, type = "est", show.values = T)
re <- sjPlot::plot_model(len_avg_lai_m1, type = "re")
re[[1]] + ggtitle("Random effects: tube:block")
re[[2]] + ggtitle("Random effects: block")
re[[3]] + ggtitle("Random effects: month")
```

Positive relationship between root length and LAI. Negative relationship with maximum temperature.

<!-- #### Summed root length -->
```{r tube summed root length, eval=FALSE}
len_tot_m1 <- lmer(tot_length_mm ~ max_temp + avg_vwc + clipped + clipped:manure + composition + (1|block/Tube) + (1|month_num), data = tube_model_data)
len_tot_m2 <- lmer(tot_length_mm ~ min_temp + avg_vwc + clipped + clipped:manure + composition + (1|block/Tube) + (1|month_num), data = tube_model_data)
len_tot_m3 <- lmer(tot_length_mm ~ avg_temp + avg_vwc + clipped + clipped:manure + composition + (1|block/Tube) + (1|month_num), data = tube_model_data)
AIC(len_tot_m1, len_tot_m2, len_tot_m3)# max temp ever so slightly better
summary(len_tot_m1)
plot(len_tot_m1)
DHARMa::simulateResiduals(len_tot_m1) %>% plot()
sjPlot::plot_model(len_tot_m1, type = "est", show.values = T)
re <- sjPlot::plot_model(len_tot_m1, type = "re")
re[[1]] + ggtitle("Random effects: tube:block")
re[[2]] + ggtitle("Random effects: block")
re[[3]] + ggtitle("Random effects: month")
# sjPlot::tab_model(len_tot_m1)

len_tot_m1a <- lmer(tot_length_mm ~ max_temp + avg_vwc + clipped + clipped:manure + composition + (1|block/Tube) + (1|month_num), data = tube_model_data)
sjPlot::plot_model(len_tot_m1a, type = "est", show.values = T)
```

<!-- #### Summed root length model with LAI -->
```{r tube summed length with LAI, eval=FALSE}
len_tot_lai_m1 <- lmer(tot_length_mm ~ max_temp + avg_vwc + clipped + clipped:manure + composition + (1|block/Tube) + (1|month_num), data = tube_lai_model_data)
summary(len_tot_lai_m1)
plot(len_tot_lai_m1)
DHARMa::simulateResiduals(len_tot_lai_m1) %>% plot()
sjPlot::plot_model(len_tot_lai_m1, type = "est", show.values = T)
re <- sjPlot::plot_model(len_tot_lai_m1, type = "re")
re[[1]] + ggtitle("Random effects: tube:block")
re[[2]] + ggtitle("Random effects: block")
re[[3]] + ggtitle("Random effects: month")
# sjPlot::tab_model(len_tot_lai_m1)
```


#### Average root volume
```{r tube avg volume}
vol_avg_m1 <- lmer(avg_volume_mm3 ~ max_temp + avg_vwc + clipped + clipped:manure + (1|block/Tube) + (1|month_num), data = tube_model_data)
vol_avg_m2 <- lmer(avg_volume_mm3 ~ min_temp + avg_vwc + clipped + clipped:manure + composition + (1|block/Tube) + (1|month_num), data = tube_model_data)
vol_avg_m3 <- lmer(avg_volume_mm3 ~ avg_temp + avg_vwc + clipped + clipped:manure + composition + (1|block/Tube) + (1|month_num), data = tube_model_data)
AIC(vol_avg_m1, vol_avg_m2, vol_avg_m3) %>% 
  arrange(AIC)# max temp < min and avg temp

plot(vol_avg_m1)
DHARMa::simulateResiduals(vol_avg_m1) %>% plot()

summary(vol_avg_m1)
sjPlot::plot_model(vol_avg_m1, type = "est", show.values = T)
re <- sjPlot::plot_model(vol_avg_m1, type = "re", grid = T)
(re[[1]] + ggtitle("Random effects: tube:block")) 
(re[[2]] + ggtitle("Random effects: block")) 
(re[[3]] + ggtitle("Random effects: month"))
# sjPlot::tab_model(vol_avg_m3)

vol_avg_m1a <- lmer(avg_volume_mm3 ~ std2_max_temp + std2_avg_vwc + clipped + clipped:manure + (1|block/Tube) + (1|month_num), data = tube_model_data)
sjPlot::plot_model(vol_avg_m1a, type = "est", show.values = T) +
  ggtitle("Volume model with standardized variables")
```

Negative effect of clipping, positive direction for simulated grazing and soil moisture (standardized).

#### Average root volume model with LAI
```{r tube avg volume with LAI}
vol_avg_lai_m1 <- lmer(avg_volume_mm3 ~ max_temp + avg_vwc + avg_lai + composition + (1|block/Tube) + (1|month_num), data = tube_model_data)

summary(vol_avg_lai_m1)
sjPlot::plot_model(vol_avg_lai_m1, type = "est", show.values = T)
re <- sjPlot::plot_model(vol_avg_lai_m1, type = "re", grid = T)
(re[[1]] + ggtitle("Random effects: tube:block")) 
(re[[2]] + ggtitle("Random effects: block")) 
(re[[3]] + ggtitle("Random effects: month"))
```

No effect of LAI.

```{r tube summed volume, eval=FALSE}
vol_tot_m1 <- lmer(tot_volume_mm3 ~ max_temp + avg_vwc + clipped + clipped:manure + (1|block/Tube) + (1|month_num), data = tube_model_data)
vol_tot_m2 <- lmer(tot_volume_mm3 ~ min_temp + avg_vwc + clipped + clipped:manure + composition + (1|block/Tube) + (1|month_num), data = tube_model_data)
vol_tot_m3 <- lmer(tot_volume_mm3 ~ avg_temp + avg_vwc + clipped + clipped:manure + composition + (1|block/Tube) + (1|month_num), data = tube_model_data)
AIC(vol_tot_m1, vol_tot_m2, vol_tot_m3)# avg temp ever so slightly < min temp
summary(vol_tot_m3)
plot(vol_tot_m3)
DHARMa::simulateResiduals(vol_tot_m3) %>% plot()
sjPlot::plot_model(vol_tot_m3, type = "est", show.values = T)
sjPlot::tab_model(vol_tot_m3)
```

#### Average root diameter
```{r tube avg diameter}
dia_avg_m1 <- lmer(avg_diam_mm ~ max_temp + avg_vwc + clipped + clipped:manure + (1|block/Tube) + (1|month_num), data = tube_model_data)
dia_avg_m2 <- lmer(avg_diam_mm ~ min_temp + avg_vwc + clipped + clipped:manure + composition + (1|block/Tube) + (1|month_num), data = tube_model_data)
dia_avg_m3 <- lmer(avg_diam_mm ~ avg_temp + avg_vwc + clipped + clipped:manure + composition + (1|block/Tube) + (1|month_num), data = tube_model_data)
AIC(dia_avg_m1, dia_avg_m2, dia_avg_m3) %>% 
  arrange(AIC)# max temp < min and avg temp

plot(dia_avg_m1)
DHARMa::simulateResiduals(dia_avg_m1) %>% plot()

summary(dia_avg_m1)
sjPlot::plot_model(dia_avg_m1, type = "est", show.values = T)
re <- sjPlot::plot_model(dia_avg_m1, type = "re", grid = T)
(re[[1]] + ggtitle("Random effects: tube:block")) 
(re[[2]] + ggtitle("Random effects: block")) 
(re[[3]] + ggtitle("Random effects: month"))
# sjPlot::tab_model(dia_avg_m1)

dia_avg_m1a <- lmer(avg_diam_mm ~ std2_max_temp + std2_avg_vwc + clipped + clipped:manure + (1|block/Tube) + (1|month_num), data = tube_model_data)
sjPlot::plot_model(dia_avg_m1a, type = "est", show.values = T) +
  scale_y_continuous(limits = c(-.1,.1)) +
  ggtitle("Diameter model with standardized variables")
```

Maybe a tiny influence of clipping on average root diameter.

#### Average root diameter model with LAI
```{r avg root diam with LAI}
dia_avg_lai_m1 <- lmer(avg_diam_mm ~ max_temp + avg_vwc + avg_lai + composition + (1|block/Tube) + (1|month_num), data = tube_lai_model_data)

plot(dia_avg_lai_m1)
DHARMa::simulateResiduals(dia_avg_lai_m1) %>% plot()

summary(dia_avg_lai_m1)
sjPlot::plot_model(dia_avg_lai_m1, type = "est", show.values = T)
re <- sjPlot::plot_model(dia_avg_lai_m1, type = "re", grid = T)
(re[[1]] + ggtitle("Random effects: tube:block")) 
(re[[2]] + ggtitle("Random effects: block")) 
(re[[3]] + ggtitle("Random effects: month"))
```

Ugly quantiles diagnostic plots. No effect of LAI.


```{r tube summed diameter, eval=FALSE}
dia_tot_m1 <- lmer(tot_diam_mm ~ max_temp + avg_vwc + clipped + clipped:manure + (1|block/Tube) + (1|month_num), data = tube_model_data)
dia_tot_m2 <- lmer(tot_diam_mm ~ min_temp + avg_vwc + clipped + clipped:manure + composition + (1|block/Tube) + (1|month_num), data = tube_model_data)
dia_tot_m3 <- lmer(tot_diam_mm ~ avg_temp + avg_vwc + clipped + clipped:manure + composition + (1|block/Tube) + (1|month_num), data = tube_model_data)
AIC(dia_tot_m1, dia_tot_m2, dia_tot_m3)# avg temp ever so slightly < min temp
summary(dia_tot_m3)
plot(dia_tot_m3)
DHARMa::simulateResiduals(dia_tot_m3) %>% plot()
sjPlot::plot_model(dia_tot_m3, type = "est", show.values = T)
sjPlot::plot_model(dia_tot_m3, type = "std2", show.values = T)
sjPlot::tab_model(dia_tot_m3)
```



## Number of roots across size bins

<!-- add diameter bins -->

```{r bins_length_diam_fig, fig.height=6, fig.width=8}
length_bins <- ggplot(df, aes(length_bin, fill = root_status)) +
  geom_bar(position = "dodge") +
  scale_y_continuous(expand = c(0,0)) +
  xlab("Root length bin") +
  ylab("Root count") +
  facet_grid(Month~.) +
  theme_minimal() +
  theme(legend.position = c(.8, .8),
        legend.title = element_blank(),
        panel.grid.minor = element_blank())
length_bins

diam_bins <- ggplot(df, aes(diam_bin, fill = root_status)) +
  geom_bar(position = "dodge") +
  scale_y_continuous(expand = c(0,0)) +
  xlab("Root diameter bin") +
  ylab("Root count") +
  facet_grid(Month~.) +
  theme_minimal() +
  theme(legend.position = c(.8, .8),
        legend.title = element_blank(),
        panel.grid.minor = element_blank())
diam_bins

# ggpubr::ggarrange(
#   length_bins + theme(legend.position = "none"), 
#   diam_bins + ylab(" ")
# )
```


```{r density_plot_length_diam, fig.height=6, fig.width=6}
length_dens <- ggplot(df) +
  geom_density(aes(Length_mm, color = root_status)) +
  scale_x_continuous(breaks = c(seq(0,10, 2), 10, 20, 30, 40, 50, 60),
                     labels = c(seq(0,10, 2), 10, 20, 30, 40, 50, 60),
                     expand = c(.01,.01)) +
  scale_y_continuous(expand = c(.001,.001)) +
  xlab("Root length (mm)") +
  theme_minimal() +
  theme(legend.position = "none",
        # legend.title = element_blank(),
        panel.grid.minor = element_blank())
length_dens

diam_dens <- ggplot(df) +
  geom_density(aes(AvgDiam_mm, color = root_status)) +
  scale_x_continuous(breaks = c(seq(0,5, 1), 10, 20),
                     labels = c(seq(0,5, 1), 10, 20),
                     expand = c(.01,.01)) +
  scale_y_continuous(expand = c(.001,.001)) +
  xlab("Average root diameter (cm)") +
  theme_minimal() +
  theme(legend.position = "none",
        # legend.title = element_blank(),
        panel.grid.minor = element_blank())
diam_dens
```


## Individual roots
Plotted metrics by depth, month, and status

```{r root_length_depth_month}
ggplot(df, aes(Location*-1, Length_mm)) +
  geom_point(alpha = .2) +
  # stat_summary(fun.data = "mean_se", color = "deepskyblue", size = .2) +
  geom_smooth(method = "gam") +
  coord_flip() +
  facet_grid(Month ~ root_status) +
  xlab("Relative depth") +
  ylab("Root length (mm)") +
  theme_bw() +
  theme(
    # legend.position = c(.8, .8),
    # legend.title = element_blank(),
    strip.background = element_blank(),
    panel.grid.minor = element_blank()
    )
```

```{r diameter_depth_month}
ggplot(df, aes(Location*-1, AvgDiam_mm)) +
  geom_point(alpha = .2) +
  # stat_summary(fun.data = "mean_se", color = "deepskyblue", size = .2) +
  geom_smooth(method = "gam") +
  coord_flip() +
  facet_grid(Month ~ root_status) +
  xlab("Relative depth") +
  ylab("Root diameter") +
  theme_bw() +
  theme(
    # legend.position = c(.8, .8),
    # legend.title = element_blank(),
    strip.background = element_blank(),
    panel.grid.minor = element_blank()
    )
```



## Averaged individual root measurements

Root length, diameter, and volume by depth, month, and status.

Points are means, blue error bars are standard errors, red are 95% CI. Both calculated using `stat_summary()` implementation. The line is the fit from `geom_smooth(method = 'gam', formula = 'y ~ s(x, bs="cs)')`, the default action in this case.

<!-- Add figure of medians, mode, explore using standard deviation -->

```{r avg_length_depth_month}
ggplot(df, aes(Location*-1, Length_mm)) +
  # geom_point(alpha = .2) +
  # stat_summary(fun.data = "median_hilow", color = "red", size = .2) +
  stat_summary(fun.data = "mean_cl_boot", color = "red", size = .2) +
  stat_summary(fun.data = "mean_se", color = "deepskyblue", size = .2) +
  # stat_summary(fun = "median", color = "deepskyblue", size = .2) +
  geom_smooth() +
  coord_flip() +
  facet_grid(Month ~ root_status) +
  xlab("Relative depth") +
  ylab("Average root length (mm)") +
  theme_bw() +
  theme(
    # legend.position = c(.8, .8),
    # legend.title = element_blank(),
    strip.background = element_blank(),
    panel.grid.minor = element_blank()
    )
```

```{r avg_diam_depth_month}
ggplot(df, aes(Location*-1, AvgDiam_mm)) +
  # geom_point(alpha = .05) +
  # stat_summary(fun.data = "mean_sdl", color = "red", size = .2, fun.args = list(mult=1)) +
  stat_summary(fun.data = "mean_cl_boot", color = "red", size = .2) +
  stat_summary(fun.data = "mean_se", color = "deepskyblue", size = .2) +
  # stat_summary(fun = median, geom = "point", color = "red", size = .1) +
  geom_smooth() +
  coord_flip() +
  facet_grid(Month ~ root_status) +
  xlab("Relative depth") +
  ylab("Average root diameter (cm)") +
  theme_bw() +
  theme(
    # legend.position = c(.8, .8),
    # legend.title = element_blank(),
    strip.background = element_blank(),
    panel.grid.minor = element_blank()
    )
```

```{r avg_volume_depth_month}
ggplot(df, aes(Location*-1, Volume_mm3)) +
  # geom_point(alpha = .05) +
  # stat_summary(fun.data = "mean_sdl", color = "red", size = .2, fun.args = list(mult=1)) +
  stat_summary(fun.data = "mean_cl_boot", color = "red", size = .2) +
  stat_summary(fun.data = "mean_se", color = "deepskyblue", size = .2) +
  # stat_summary(fun = median, geom = "point", color = "red", size = .1) +
  geom_smooth() +
  coord_flip() +
  facet_grid(Month ~ root_status) +
  xlab("Relative depth") +
  ylab("Average root volume (mm3)") +
  theme_bw() +
  theme(
    strip.background = element_blank(),
    panel.grid.minor = element_blank()
    )
```
